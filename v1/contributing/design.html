<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Overall design - flutter_rust_bridge</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">flutter_rust_bridge</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="overall-design"><a class="header" href="#overall-design">Overall design</a></h1>
<blockquote>
<p>This doc is still WIP. Tracking issue: https://github.com/fzyzcjy/flutter_rust_bridge/issues/593</p>
</blockquote>
<h2 id="folder-structure"><a class="header" href="#folder-structure">Folder structure</a></h2>
<ul>
<li><code>frb_codegen</code>: Code generator. It inputs <code>api.rs</code> and outputs Rust and Dart code files.</li>
<li><code>frb_example</code>: Examples.
<ul>
<li><code>pure_dart</code>: Not only an example, but, more importantly, serves as end-to-end tests.</li>
<li><code>with_flutter</code>: Example with integration into Flutter.</li>
<li><code>pure_dart_multi</code>: Demonstrate multi-file usage.</li>
</ul>
</li>
<li><code>frb_dart</code>: Support library for Dart - to be imported by users.</li>
<li><code>frb_rust</code>: Support library for Rust - to be imported by users.</li>
<li><code>frb_macros</code>: Indeed part of <code>frb_rust</code>. <small>It is a separate package simply because limitation of proc macros.</small></li>
<li><code>book</code>: The documentation.</li>
<li><code>.github</code>: GitHub-related.
<ul>
<li><code>workflows/ci.yaml</code>: Definition of CI workflows.</li>
</ul>
</li>
</ul>
<h2 id="terminology"><a class="header" href="#terminology">Terminology</a></h2>
<p><strong>Rust IO Wire</strong> types refers to the C types the Dart VM uses to communicate with the Rust library.</p>
<p><strong>Dart IO Wire</strong> types are the Dart counterpart of Rust IO wire types, but in
the <code>*.io.dart</code> files. Both Rust and Dart wire types communicate using the
vocabulary of C types, aka primitives, structs, unions and pointers.</p>
<p><strong>Rust JS Wire</strong> types are the WASM equivalent of Rust IO
wire types, many of which are distinct from their C siblings.
In addition, these types may also take the form of the catch-all <code>JsValue</code>.</p>
<p><strong>Dart JS Wire</strong> types are the WASM equivalent of Dart IO wire types, but
unlike Rust JS wire types, most of these types remain identical to their real API counterparts.
Similar to the the relationship between Rust IO and Dart IO wire types, Rust JS and Dart JS wire types
use the vocabulary of JavaScript types, aka primitives, arrays, typed arrays and objects.</p>
<h2 id="code-generator-structure"><a class="header" href="#code-generator-structure">Code-generator structure</a></h2>
<p>The pipeline is as follows:</p>
<pre class="mermaid">flowchart LR
api.rs -- src/parser --&gt; src/ir
src/ir -- src/generator --&gt; rd[Rust &amp; Dart]
</pre>
<ul>
<li>The input, <code>api.rs</code> in the figure, is the user-provided handwritten Rust code.</li>
<li>The parser (<code>src/parser</code>) converts the input code (indeed <a href="https://crates.io/crates/syn">syn</a> tree) into IR.</li>
<li>IR (<code>src/ir</code>), or internal representation, is a data structure that represents the information of the code that we are interested in.</li>
<li>The generator (<code>src/generator</code>) converts the IR into final outputs. More specifcially, as you can probably guess, <code>src/generator/dart</code> generates Dart code, <code>src/generator/rust</code> is for Rust code, and <code>src/generator/c</code> is for (a bit of) C code.</li>
<li>The outputs (<code>Rust &amp; Dart</code> in the figure) are written to corresponding files.</li>
</ul>
<h2 id="data-flow"><a class="header" href="#data-flow">Data flow</a></h2>
<p>Let us see what happens when a function is called.</p>
<p>Suppose a user calls a (generated) Dart function <code>func({required String str})</code>. Then, the following happens:</p>
<ol>
<li>The generated Dart function, <code>func({required String str})</code>, convert "<em>Dart api data</em>" (i.e. the data that user really provides) into "<em>Dart wire data</em>" (i.e. the data that will really pass between Dart and Rust). More specifically, it calls <code>_api2wire_String(str)</code> and get a <code>ffi.Pointer&lt;wire_uint_8_list&gt;</code> (because <code>String</code>s use <code>pub struct wire_uint_8_list { ptr: *mut u8, len: i32 }</code> under the hood).</li>
<li>Now we call the Dart version of <code>wire_func</code>, with low-level data like <code>wire_uint_8_list</code>. We have used our codegen to create a Rust <code>wire_func</code> function, and use <code>cbindgen</code> to generate the corresponding C function, and use <code>ffigen</code> to get the corresponding Dart function. Here, we call the Dart version of <code>wire_func</code>. Since Dart FFI and Rust FFI is C-compatible, it seamlessly calls the Rust version of <code>wire_func</code>. Notice that, since we are utilizing C-compatible functions (and it is the only feasible way), we can only pass around low-level things like pointers, instead of high-level and safe things.</li>
<li>Surely, the Rust <code>wire_func</code> is called. The function uses <code>.wire2api()</code> to convert "<em>Rust wire data</em>" (<code>wire_uint_8_list</code> here) into "<em>Rust api data</em>" (<code>String</code> here, i.e. data that users really use).</li>
<li>The <code>FLUTTER_RUST_BRIDGE_HANDLER</code> is called with "<em>Rust api data</em>". That handler is user-customizable, so users may provide their own implementation other than the default thread-pool, etc. By default, we use a thread pool, and we call the user-written <code>func</code> Rust function in <code>api.rs</code>.</li>
<li>The user-written <code>fn func(str: String) -&gt; String { ... }</code> is called, and we get a return value.</li>
<li>The return value, a <code>String</code>, is posted to the Dart side. It is done by the Dart-provided API, <a href="https://github.com/dart-lang/sdk/blob/fd0d3b254690007d0ebc84175f30fa7d7491ec3e/runtime/include/dart_native_api.h#L124"><code>Dart_PostCObject</code></a>, which let us provide C structs and it will automatically become Dart data on the other side. We use the Rust-safe wrapper <code>allo-isolate</code> for it. We deliberately choose this, because this enables Dart code to be <em>async</em> instead of sync.</li>
<li>On the Dart side, we now see some Dart objects (indeed "<em>Dart wire data</em>"). We use functions like <code>_wire2api_SomeType</code> to convert it to the final "<em>Dart api data</em>". Notice this "wire2api" is on <em>Dart</em> side, so it means "<em>Dart</em> wire data to <em>Dart</em> api data", and is different from the one above which is for Rust. For example, since <code>Dart_PostCObject</code> does not provide a way to construct arbitrary structs(classes), we have to pass Rust structs as lists, and use the <code>wire2api</code> to convert them to corresponding Dart classes.</li>
<li>The final result value is provided as return value of the Dart function, <code>func</code>, that the user called just now. A function call finishes!</li>
</ol>
<h2 id="type-mappings"><a class="header" href="#type-mappings">Type Mappings</a></h2>
<p>Unless otherwise noted, <code>T</code> refers to a type from the same column or the generic type.
Does not include delegated types.</p>
<div class="table-wrapper"><table><thead><tr><th>Rust</th><th>Rust IO Wire</th><th>Dart IO Wire</th><th>Rust JS Wire</th><th>Dart JS Wire</th><th>Dart</th></tr></thead><tbody>
<tr><td><code>i{8..32}</code></td><td><code>i{8..32}</code></td><td><code>int</code><sup class="footnote-reference"><a href="#1">1</a></sup></td><td><code>i{8..32}</code></td><td><code>int</code></td><td><code>int</code></td></tr>
<tr><td><code>u{8..32}</code></td><td><code>u{8..32}</code></td><td><code>int</code><sup class="footnote-reference"><a href="#1">1</a></sup></td><td><code>u{8..32}</code></td><td><code>int</code></td><td><code>int</code></td></tr>
<tr><td><code>i64</code></td><td><code>i64</code></td><td><code>int</code></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/BigInt"><code>BigInt</code></a></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/BigInt"><code>BigInt</code></a></td><td><code>int</code></td></tr>
<tr><td><code>u64</code></td><td><code>u64</code></td><td><code>int</code></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/BigInt"><code>BigInt</code></a></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/BigInt"><code>BigInt</code></a></td><td><code>int</code></td></tr>
<tr><td><code>usize</code></td><td><code>usize</code></td><td><code>int</code></td><td><code>usize</code></td><td><code>int</code></td><td><code>int</code></td></tr>
<tr><td><code>bool</code></td><td><code>bool</code></td><td><code>bool</code></td><td><code>bool</code></td><td><code>bool</code></td><td><code>bool</code></td></tr>
<tr><td><code>Vec&lt;i{8..32}&gt;</code></td><td><code>wire_int_{8..32}_list</code></td><td><code>wire_int_{8..32}_list</code></td><td><code>Box&lt;[i{8..32}]&gt;</code></td><td><code>Int{8..32}Array</code></td><td><code>Int{8..32}List</code></td></tr>
<tr><td><code>Vec&lt;u{8..32}&gt;</code></td><td><code>wire_uint_{8..32}_list</code></td><td><code>wire_uint_{8..32}_list</code></td><td><code>Box&lt;[u{8..32}]&gt;</code></td><td><code>Uint{8..32}Array</code></td><td><code>Uint{8..32}List</code></td></tr>
<tr><td><code>Vec&lt;i64&gt;</code></td><td><code>wire_int_64_list</code></td><td><code>wire_int_64_list</code></td><td><code>Box&lt;[i64]&gt;</code></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/BigInt64Array"><code>BigInt64Array</code></a></td><td><code>Int64List</code><sup class="footnote-reference"><a href="#2">2</a></sup></td></tr>
<tr><td><code>Vec&lt;u64&gt;</code></td><td><code>wire_uint_64_list</code></td><td><code>wire_uint_64_list</code></td><td><code>Box&lt;[u64]&gt;</code></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/BigUint64Array"><code>BigUint64Array</code></a></td><td><code>Uint64List</code><sup class="footnote-reference"><a href="#2">2</a></sup></td></tr>
<tr><td><code>String</code></td><td><code>wire_uint_8_list</code></td><td><code>wire_uint_8_list</code></td><td><code>String</code></td><td><code>String</code></td><td><code>String</code></td></tr>
<tr><td><code>Vec&lt;String&gt;</code></td><td><code>wire_StringList</code></td><td><code>wire_StringList</code></td><td><code>Box&lt;[String]&gt;</code></td><td><code>List</code></td><td><code>List&lt;String&gt;</code></td></tr>
<tr><td><code>Vec&lt;T&gt;</code></td><td><code>wire_list_t</code></td><td><code>wire_list_t</code></td><td><code>Box&lt;[JsValue]&gt;</code></td><td><code>List</code></td><td><code>List&lt;T&gt;</code></td></tr>
<tr><td><code>Box&lt;T&gt;</code></td><td><code>*mut T</code></td><td><code>ffi.Pointer&lt;T&gt;</code></td><td><code>T</code></td><td><code>T</code></td><td><code>T</code></td></tr>
<tr><td><code>Option&lt;T&gt;</code></td><td><code>*mut T</code></td><td><code>ffi.Pointer&lt;T&gt;</code></td><td><code>Option&lt;T&gt;</code></td><td><code>T?</code></td><td><code>T?</code></td></tr>
<tr><td><code>Option&lt;Box&lt;T&gt;&gt;</code></td><td><code>*mut T</code></td><td><code>ffi.Pointer&lt;T&gt;</code></td><td><code>Option&lt;T&gt;</code></td><td><code>T?</code></td><td><code>T?</code></td></tr>
<tr><td>enum/struct <code>T</code></td><td><code>*mut wire_t</code></td><td><code>ffi.Pointer&lt;T&gt;</code></td><td><code>Array</code></td><td><code>List</code></td><td>class <code>T</code></td></tr>
<tr><td>enum <code>T</code><sup class="footnote-reference"><a href="#3">3</a></sup></td><td><code>i32</code><sup class="footnote-reference"><a href="#5">4</a></sup></td><td><code>int</code><sup class="footnote-reference"><a href="#1">1</a></sup></td><td><code>i32</code><sup class="footnote-reference"><a href="#5">4</a></sup></td><td><code>int</code></td><td>enum <code>T</code></td></tr>
<tr><td><a href="https://docs.rs/flutter_rust_bridge/latest/flutter_rust_bridge/ffi/type.DartAbi.html"><code>DartAbi</code></a></td><td><a href="https://docs.rs/flutter_rust_bridge/latest/flutter_rust_bridge/ffi/io/ffi/struct.DartCObject.html"><code>DartCObject</code></a></td><td><code>dynamic</code></td><td><a href="https://rustwasm.github.io/wasm-bindgen/reference/types/jsvalue.html"><code>JsValue</code></a></td><td><code>dynamic</code></td><td><code>dynamic</code></td></tr>
</tbody></table>
</div>
<h2 id="memory-safety"><a class="header" href="#memory-safety">Memory safety</a></h2>
<p>How is memory safety implemented? This is a case-by-case problem. For example, suppose we want to see how a <code>String</code> is safely passed from Dart to Rust. Then, we need to examine the Dart <code>_api2wire_String</code> and the Rust <code>.wire2api()</code> for it.</p>
<p>Indeed <code>String</code> is implemented by delegating to <code>Vec&lt;u8&gt;</code>, so we need to see code related to String as well as <code>Vec&lt;u8&gt;</code>. By simply clicking a few times and jump around code, we will see that:</p>
<pre><code class="language-dart">ffi.Pointer&lt;wire_uint_8_list&gt; _api2wire_String(String raw) {
  return _api2wire_uint_8_list(utf8.encoder.convert(raw));
}

ffi.Pointer&lt;wire_uint_8_list&gt; _api2wire_uint_8_list(Uint8List raw) {
  final ans = inner.new_uint_8_list_0(raw.length);
  ans.ref.ptr.asTypedList(raw.length).setAll(0, raw);
  return ans;
}
</code></pre>
<p>and</p>
<pre><code class="language-rust noplayground">impl Wire2Api&lt;Vec&lt;u8&gt;&gt; for *mut wire_uint_8_list {
    fn wire2api(self) -&gt; Vec&lt;u8&gt; {
        unsafe {
            let wrap = support::box_from_leak_ptr(self);
            support::vec_from_leak_ptr(wrap.ptr, wrap.len)
        }
    }
}

impl Wire2Api&lt;String&gt; for *mut wire_uint_8_list {
    fn wire2api(self) -&gt; String {
        let vec: Vec&lt;u8&gt; = self.wire2api();
        String::from_utf8_lossy(&amp;vec).into_owned()
    }
}

pub struct wire_uint_8_list {
    ptr: *mut u8,
    len: i32,
}</code></pre>
<p>In other words, String (or <code>Vec&lt;u8&gt;</code>) is converted to a raw struct with pointer and length field. The memory is manipulated carefully so there is no leak or double free.</p>
<p>We use Valgrind to check as well, and I use it in production environment without problems, so no worries about memory problems :)</p>
<h2 id="dart-bridge-hierarchy"><a class="header" href="#dart-bridge-hierarchy">Dart bridge hierarchy</a></h2>
<p>A bridge module consists of several classes:</p>
<ul>
<li>One <code>_Impl</code> class implementing the wire functions and common helpers; and</li>
<li>One or more <code>_Platform</code> classes implementing the platform-specific helpers.</li>
</ul>
<p>The implementor class takes a platform class as a private attribute, and the platform
class exposes all of its members decorated with <code>@protected</code>. The specific platform class
to be used is gated by conditional imports.</p>
<h2 id="cross-scope-communication-in-the-browser"><a class="header" href="#cross-scope-communication-in-the-browser">Cross-scope communication in the browser</a></h2>
<p>On Web platforms, for lack of a proper <code>SendPort</code> there exists replacements from <code>dart:html</code>.</p>
<p><strong>MessagePort</strong> replaces <code>dart:ffi</code>'s <code>SendPort</code> and is created from <code>MessageChannel</code>. The Dart
thread creates a channel, keeps the receive port and transfers the send port to the workers.</p>
<pre class="mermaid">sequenceDiagram
Dart -&gt;&gt; Rust: port2
Rust -&gt;&gt; Rust Worker: port2
Rust Worker -&gt;&gt; Dart: port2.postMessage
</pre>
<p><strong>BroadcastChannel</strong> replaces <code>dart:ffi</code>'s <code>SendPort</code> for <code>StreamSink</code>s, due to the fact that wasm_bindgen
keeps the ports in a JS-local scope that cannot be shared with other threads. A broadcast channel
is created by Dart, then passed to the main Rust thread. Rust then transfers its name to the workers.
When other workers refer to a <code>StreamSink</code> from another worker, e.g. if the sink was put in a static variable,
a new <code>BroadcastChannel</code> will be created from its name.</p>
<p><code>BroadcastChannel</code>s are guaranteed to be unique for each invocation.<sup class="footnote-reference"><a href="#4">5</a></sup></p>
<pre class="mermaid">sequenceDiagram
Dart -&gt;&gt; Rust: channel
Rust -&gt;&gt; Rust Worker 1: channel.name
Rust Worker 1 -&gt;&gt; Dart: channel.postMessage
Rust -&gt;&gt; Rust Worker 2: channel.name
Rust Worker 2 -&gt;&gt; Dart: channel.postMessage
</pre>
<p>It is theoretically possible to have a one-to-one implementation of Isolate using only web primitives,
<code>BroadcastChannel</code>s and <code>Worker</code>s, but it remains to be seen how practical such an approach would be.</p>
<h2 id="optionallist"><a class="header" href="#optionallist">OptionalList</a></h2>
<p>Per the implementation, most IRs are also accompanied by a List type (GeneralList, PrimitiveList, StringList etc.)
each of which handles lists in different ways. When Optional was first implemented, it relied on GeneralList since the
underlying assumption that Optional already boxed stack values should allow for seamless interaction. Howver, this became an issue
later because other IRs would have to accommodate for Optionals instead of being perfectly encapsulated, leading to
ugly hacks. <a href="https://github.com/fzyzcjy/flutter_rust_bridge/pull/1388">#1388</a> introduced OptionalList to bring
Optional in line with other IRs, and is implemented as a list of maybe-null pointers. It does highlight several drawbacks
to this approach to IRs where specializations shine compared to GeneralList.</p>
<ol>
<li>GeneralList requires a fully-allocated list and asks the Dart side to <em>fill</em> in the blanks via <code>api_fill</code> functions, but these
are not implemented by any delegates since they all have their own special lists (StringList, TimeList, Uuids). This renders
types like <code>List&lt;String?&gt;</code> difficult to implement without hacks.</li>
<li>OptionalList's inner pointer is a <code>*mut *mut T</code>, which without significant refactoring would be difficult to represent with
GeneralList, and whose typical usage doesn't really require double indirection often enough to justify it.</li>
<li>OptionalList enables future optimizations, for example the case when <code>sizeof(T) &lt;= sizeof(usize)</code>, which would certainly be difficult
to accomplish with GeneralList.</li>
</ol>
<h2 id="want-to-know-more-tell-me"><a class="header" href="#want-to-know-more-tell-me">Want to know more? Tell me</a></h2>
<p>What do you want to know? Feel free to create an issue in GitHub, and I will tell more :)</p>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>When behind a <code>ffi.Pointer</code>, they are their respective types from <code>dart:ffi</code>: <code>ffi.Int8</code>, <code>ffi.Int16</code>, etc.</p>
</div>
<div class="footnote-definition" id="2"><sup class="footnote-definition-label">2</sup>
<p>These types are unsupported on Web by <code>dart:typed_list</code>, so this library provides a barebores shim over the JS native types.
If you wish to use these types, replace all <code>dart:typed_list</code> imports with this library.</p>
</div>
<div class="footnote-definition" id="3"><sup class="footnote-definition-label">3</sup>
<p>Refers to C-style enums only (no fields).</p>
</div>
<div class="footnote-definition" id="4"><sup class="footnote-definition-label">5</sup>
<p>This is currently implemented as a monotonically-increasing index.</p>
</div>
<div class="footnote-definition" id="5"><sup class="footnote-definition-label">4</sup>
<p>Enums may also specify a <code>#[repr]</code>, which is planned to be implemented.</p>
</div>
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
let mdbookTheme = localStorage.getItem("mdbook-theme") || default_theme;
mermaid.initialize({
    startOnLoad: true,
    theme: mdbookTheme == 'light' || mdbookTheme == 'rust' ? 'light' : 'dark',
});
</script>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../contributing/overview.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../contributing/submodule.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../contributing/overview.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../contributing/submodule.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
